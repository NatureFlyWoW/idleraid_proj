---
name: combat-engine
description: Use when implementing, modifying, debugging, or testing any combat mechanic including damage calculation, healing, threat, DOTs, HOTs, auto-attacks, ability priorities, critical strikes, or combat AI. Covers the full attack table resolution, armor and resistance mitigation, resource systems (rage, mana, energy, focus), and class-specific combat behavior.
---

# Combat Engine Reference

## Attack Table Resolution (checked in this order, first match wins)
1. Miss (if Hit% < 100%)
2. Dodge (target dodge%)
3. Parry (melee only, frontal)
4. Block (shield users, reduces damage by 30%)
5. Critical Hit (attacker crit%)
6. Normal Hit

## Auto-Attack (White Damage)
Base = (WeaponMin/Max + (AttackPower / 14 × WeaponSpeed))
ArmorMitigation = 1 - (Armor / (Armor + 400 + 85 × AttackerLevel))
Final = Base × ArmorMitigation × OtherModifiers

## Ability (Yellow) Damage
Physical: TooltipDamage + (AttackPower × Coefficient)
Spell: TooltipDamage + (SpellPower × Coefficient)

## Spell Coefficients
Instant physical: 0.0–0.2 × AP | Instant spell: 0.2–0.4 × SP
1.5s cast: 0.57 × SP | 3.0s cast: 0.857 × SP
DOT full duration: 1.0 × SP | HOT full duration: 1.0 × SP

## Critical Strikes
Physical base: 2.0x (talents can modify) | Spell base: 1.5x (talents can modify to 2.0x)

## Resource Systems
Rage: 0–100, generated by dealing/taking damage (2–5 per auto based on weapon speed), decays 1/sec out of combat
Mana: 100 + INT×15, regen from Spirit, Five-Second Rule (regen pauses 5s after casting)
Energy: fixed 100, regenerates 10/sec
Focus (pets): 100, regen 5/sec, abilities cost 25–35

## Threat
Melee aggro threshold: 110% of tank | Ranged aggro threshold: 130% of tank
Healing: generates 50% of heal amount as threat
Tank stances: Defensive/Bear = 1.30x threat | Righteous Fury = 1.60x threat
DPS throttling: >90% of tank → reduce output 20% | >100% → use threat reduction | >110% → stop 2s

## Combat AI Priority Pattern (every class follows this structure)
1. Resource Builders (if resource < 40%)
2. Resource Spenders (if resource > 80% or boss < 20% HP)
3. Cooldowns (if available and optimal)
4. Filler Abilities (if nothing else available)
5. Auto-Attack (always occurs between abilities)

## Key Source Files
- server/game/engine/ — Combat simulator, core game loop
- server/game/systems/ — Stat calculator
- server/game/data/ — Class definitions, ability data
- shared/constants/gameConfig.ts — Balance constants and formulas
- shared/types/game.ts — Core type definitions
- Idle-Raiders-GDD.md — Section 5: Combat Mechanics (authoritative source)
